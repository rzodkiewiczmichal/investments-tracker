<div class="portfolio-view">
  <div class="page-header">
    <h1>Portfolio</h1>
    <p-button label="Add Position" icon="pi pi-plus" (onClick)="navigateToAdd()" />
  </div>

  @if (error()) {
    <p-message severity="error" [text]="error()!" styleClass="mb-4 w-full" />
    <p-button label="Retry" icon="pi pi-refresh" severity="secondary" (onClick)="loadData()" />
  }

  @if (loading()) {
    <div class="summary-cards">
      @for (i of [1,2,3,4,5]; track i) {
        <p-card>
          <p-skeleton width="60%" height="1rem" styleClass="mb-2" />
          <p-skeleton width="80%" height="2rem" />
        </p-card>
      }
    </div>
  } @else if (!error() && portfolio()) {
    <div class="summary-cards">
      <p-card>
        <div class="summary-card-content">
          <span class="label">Total Value</span>
          <span class="value">{{ formatMoney(portfolio()!.totalCurrentValue.amount) }}</span>
        </div>
      </p-card>
      <p-card>
        <div class="summary-card-content">
          <span class="label">Invested</span>
          <span class="value">{{ formatMoney(portfolio()!.totalInvestedAmount.amount) }}</span>
        </div>
      </p-card>
      <p-card>
        <div class="summary-card-content">
          <span class="label">Profit/Loss</span>
          <span class="value" [class]="getProfitLossClass(portfolio()!.totalProfitLoss.amount)">
            {{ formatMoney(portfolio()!.totalProfitLoss.amount) }}
          </span>
        </div>
      </p-card>
      <p-card>
        <div class="summary-card-content">
          <span class="label">Return</span>
          <span class="value" [class]="getProfitLossClass(portfolio()!.totalReturnPercentage)">
            {{ formatPercentage(portfolio()!.totalReturnPercentage) }}
          </span>
        </div>
      </p-card>
      <p-card>
        <div class="summary-card-content">
          <span class="label">Positions</span>
          <span class="value">{{ portfolio()!.positionsCount }}</span>
        </div>
      </p-card>
    </div>

    <p-card header="Positions" styleClass="mt-4">
      @if (positions().length === 0) {
        <div class="empty-state">
          <i class="pi pi-inbox empty-icon"></i>
          <p>No positions yet. Add your first position to get started.</p>
          <p-button label="Add Position" icon="pi pi-plus" (onClick)="navigateToAdd()" />
        </div>
      } @else {
        <p-table
          [value]="positions()"
          [rowHover]="true"
          [paginator]="positions().length > 10"
          [rows]="10"
          selectionMode="single"
          (onRowSelect)="onRowSelect($event)"
          styleClass="p-datatable-striped"
        >
          <ng-template pTemplate="header">
            <tr>
              <th>Instrument</th>
              <th>Type</th>
              <th class="text-right">Quantity</th>
              <th class="text-right">Avg Cost</th>
              <th class="text-right">Current Value</th>
              <th class="text-right">P&L</th>
              <th class="text-right">Return</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-position>
            <tr [pSelectableRow]="position" class="cursor-pointer">
              <td>
                <div class="instrument-cell">
                  <span class="instrument-name">{{ position.instrumentName }}</span>
                  <span class="instrument-symbol">{{ position.instrumentSymbol }}</span>
                </div>
              </td>
              <td>
                <p-tag [value]="position.instrumentType" [severity]="getInstrumentTypeSeverity(position.instrumentType)" />
              </td>
              <td class="text-right">{{ formatQuantity(position.quantity) }}</td>
              <td class="text-right">{{ formatMoney(position.averageCost.amount) }}</td>
              <td class="text-right font-semibold">{{ formatMoney(position.currentValue.amount) }}</td>
              <td class="text-right" [class]="getProfitLossClass(position.profitLoss.amount)">
                {{ formatMoney(position.profitLoss.amount) }}
              </td>
              <td class="text-right" [class]="getProfitLossClass(position.returnPercentage)">
                {{ formatPercentage(position.returnPercentage) }}
              </td>
            </tr>
          </ng-template>
        </p-table>
      }
    </p-card>
  }
</div>
