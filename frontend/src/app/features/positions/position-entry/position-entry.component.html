<div class="position-entry">
  <div class="page-header">
    <p-button label="Back to Portfolio" icon="pi pi-arrow-left" [text]="true" (onClick)="goBack()" />
    <h1>Add Position</h1>
  </div>

  @if (error()) {
    <p-message severity="error" [text]="error()!" styleClass="mb-4 w-full" />
  }

  @if (loadingAccounts()) {
    <p-card>
      <div class="loading-form">
        @for (i of [1,2,3,4,5,6]; track i) {
          <div class="skeleton-field">
            <p-skeleton width="30%" height="1rem" styleClass="mb-2" />
            <p-skeleton width="100%" height="2.5rem" />
          </div>
        }
      </div>
    </p-card>
  } @else if (accounts().length === 0) {
    <p-card>
      <div class="empty-state">
        <i class="pi pi-exclamation-circle empty-icon"></i>
        <p>No accounts available. Please create an account first.</p>
        <p-button label="Back to Portfolio" icon="pi pi-arrow-left" severity="secondary" (onClick)="goBack()" />
      </div>
    </p-card>
  } @else {
    <p-card>
      <form [formGroup]="form" (ngSubmit)="onSubmit()">
        <section class="form-section">
          <h2>Instrument Information</h2>

          <div class="field">
            <label for="instrumentName">Instrument Name *</label>
            <input
              pInputText
              id="instrumentName"
              formControlName="instrumentName"
              placeholder="e.g., Apple Inc."
              [class.ng-invalid]="hasFieldError('instrumentName')"
              [class.ng-dirty]="form.get('instrumentName')?.touched"
              class="w-full"
            />
            @if (hasFieldError('instrumentName')) {
              <small class="p-error">{{ getFieldError('instrumentName') }}</small>
            }
          </div>

          <div class="form-row">
            <div class="field">
              <label for="instrumentSymbol">Symbol / Ticker *</label>
              <input
                pInputText
                id="instrumentSymbol"
                formControlName="instrumentSymbol"
                placeholder="e.g., AAPL"
                [class.ng-invalid]="hasFieldError('instrumentSymbol')"
                [class.ng-dirty]="form.get('instrumentSymbol')?.touched"
                class="w-full"
              />
              @if (hasFieldError('instrumentSymbol')) {
                <small class="p-error">{{ getFieldError('instrumentSymbol') }}</small>
              }
            </div>

            <div class="field">
              <label for="instrumentType">Type *</label>
              <p-select
                id="instrumentType"
                formControlName="instrumentType"
                [options]="instrumentTypes"
                optionLabel="label"
                optionValue="value"
                placeholder="Select type"
                styleClass="w-full"
                [class.ng-invalid]="hasFieldError('instrumentType')"
                [class.ng-dirty]="form.get('instrumentType')?.touched"
              />
              @if (hasFieldError('instrumentType')) {
                <small class="p-error">{{ getFieldError('instrumentType') }}</small>
              }
            </div>
          </div>
        </section>

        <section class="form-section">
          <h2>Position Details</h2>

          <div class="field">
            <label for="accountId">Account *</label>
            <p-select
              id="accountId"
              formControlName="accountId"
              [options]="accounts()"
              optionLabel="name"
              optionValue="id"
              placeholder="Select an account"
              styleClass="w-full"
              [class.ng-invalid]="hasFieldError('accountId')"
              [class.ng-dirty]="form.get('accountId')?.touched"
            >
              <ng-template pTemplate="selectedItem" let-account>
                @if (account) {
                  {{ account.name }} ({{ account.broker }})
                }
              </ng-template>
              <ng-template pTemplate="item" let-account>
                {{ account.name }} ({{ account.broker }})
              </ng-template>
            </p-select>
            @if (hasFieldError('accountId')) {
              <small class="p-error">{{ getFieldError('accountId') }}</small>
            }
          </div>

          <div class="form-row">
            <div class="field">
              <label for="quantity">Quantity *</label>
              <p-inputNumber
                id="quantity"
                formControlName="quantity"
                [minFractionDigits]="0"
                [maxFractionDigits]="8"
                [min]="0"
                placeholder="e.g., 100"
                styleClass="w-full"
                inputStyleClass="w-full"
                [class.ng-invalid]="hasFieldError('quantity')"
                [class.ng-dirty]="form.get('quantity')?.touched"
              />
              @if (hasFieldError('quantity')) {
                <small class="p-error">{{ getFieldError('quantity') }}</small>
              }
            </div>

            <div class="field">
              <label for="averageCost">Average Cost (PLN) *</label>
              <p-inputNumber
                id="averageCost"
                formControlName="averageCost"
                mode="currency"
                currency="PLN"
                locale="pl-PL"
                [minFractionDigits]="2"
                [maxFractionDigits]="4"
                [min]="0"
                placeholder="e.g., 600.00"
                styleClass="w-full"
                inputStyleClass="w-full"
                [class.ng-invalid]="hasFieldError('averageCost')"
                [class.ng-dirty]="form.get('averageCost')?.touched"
              />
              @if (hasFieldError('averageCost')) {
                <small class="p-error">{{ getFieldError('averageCost') }}</small>
              }
            </div>
          </div>
        </section>

        <div class="form-actions">
          <p-button label="Cancel" severity="secondary" [outlined]="true" (onClick)="goBack()" />
          <p-button
            type="submit"
            label="Create Position"
            icon="pi pi-plus"
            [loading]="loading()"
            [disabled]="loading()"
          />
        </div>
      </form>
    </p-card>
  }
</div>
